---
/**
 * Contact Page
 *
 * Features:
 * - Contact form with AWS Lambda + Microsoft Graph
 * - Cloudflare Turnstile CAPTCHA
 * - Calendly integration placeholder
 * - Direct contact info
 */

import BaseLayout from '@/layouts/BaseLayout.astro';
import { SITE } from '@/lib/constants';
import { IMAGES } from '@/lib/images';
import AnimatedSection from '@/components/islands/AnimatedSection';
import FloatingElements from '@/components/islands/FloatingElements';
import Button from '@/components/ui/Button.astro';

// Configuration - Update these values for your deployment
const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '1x00000000000000000000AA'; // Test key for development
const CONTACT_API_URL = import.meta.env.PUBLIC_CONTACT_API_URL || '';
---

<BaseLayout
  title="Contact Us"
  description="Get in touch with Hybetech. Book a free AI assessment or send us a message. We typically respond within 24 hours."
>
  <!-- Hero -->
  <section class="relative section-sm bg-primary-900 overflow-hidden">
    <!-- Background Image -->
    <div class="absolute inset-0">
      <img
        src={IMAGES.people.working}
        alt=""
        class="w-full h-full object-cover opacity-15"
        loading="eager"
      />
      <div class="absolute inset-0 bg-gradient-to-r from-primary-900 via-primary-900/95 to-primary-900/80"></div>
    </div>

    <FloatingElements client:load variant="minimal" />

    <div class="container-wide relative z-10">
      <AnimatedSection client:visible>
        <div class="max-w-3xl">
          <span class="badge mb-4">Get in Touch</span>
          <h1 class="text-h1 font-heading font-bold text-primary-100">
            Let's Talk
          </h1>
          <p class="mt-4 text-body-lg text-primary-300">
            Ready to explore how AI can transform your business? Book a free assessment or send us a message.
          </p>
        </div>
      </AnimatedSection>
    </div>
  </section>

  <!-- Contact Form Section -->
  <section class="section bg-primary-950">
    <div class="container-wide">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Form -->
        <AnimatedSection client:visible direction="left">
          <h2 class="text-h3 font-heading font-semibold text-primary-100 mb-6">
            Send Us a Message
          </h2>

          <form id="contact-form" class="space-y-6" novalidate>
            <!-- Success Message -->
            <div id="form-success" class="hidden p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-green-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                  <p class="text-green-400 font-medium">Message sent successfully!</p>
                  <p class="text-green-400/80 text-sm">We'll be in touch within 24 hours.</p>
                </div>
              </div>
            </div>

            <!-- Error Message -->
            <div id="form-error" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                  <p class="text-red-400 font-medium">Unable to send message</p>
                  <p id="error-message" class="text-red-400/80 text-sm">Please try again later.</p>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label for="firstName" class="block text-sm font-medium text-primary-300 mb-2">
                  First Name <span class="text-error-500">*</span>
                </label>
                <input
                  type="text"
                  id="firstName"
                  name="firstName"
                  required
                  autocomplete="given-name"
                  class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
                  placeholder="First name"
                />
              </div>

              <div>
                <label for="lastName" class="block text-sm font-medium text-primary-300 mb-2">
                  Last Name <span class="text-error-500">*</span>
                </label>
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  required
                  autocomplete="family-name"
                  class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
                  placeholder="Last name"
                />
              </div>
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-primary-300 mb-2">
                Email <span class="text-error-500">*</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                autocomplete="email"
                class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
                placeholder="you@company.com"
              />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
              <div>
                <label for="company" class="block text-sm font-medium text-primary-300 mb-2">
                  Company
                </label>
                <input
                  type="text"
                  id="company"
                  name="company"
                  autocomplete="organization"
                  class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
                  placeholder="Your company"
                />
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium text-primary-300 mb-2">
                  Phone
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  autocomplete="tel"
                  class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
                  placeholder="(555) 123-4567"
                />
              </div>
            </div>

            <div>
              <label for="interest" class="block text-sm font-medium text-primary-300 mb-2">
                What are you interested in?
              </label>
              <select
                id="interest"
                name="interest"
                class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent"
              >
                <option value="">Select an option</option>
                <option value="consultation">AI Consultation</option>
                <option value="training">AI Training</option>
                <option value="implementation">AI Implementation</option>
                <option value="development">Custom AI Development</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div>
              <label for="message" class="block text-sm font-medium text-primary-300 mb-2">
                Message <span class="text-error-500">*</span>
              </label>
              <textarea
                id="message"
                name="message"
                rows="5"
                required
                minlength="10"
                class="w-full px-4 py-3 bg-primary-800 border border-primary-700 rounded-lg text-primary-100 placeholder:text-primary-500 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent resize-none"
                placeholder="Tell us about your project or question..."
              ></textarea>
            </div>

            <!-- Cloudflare Turnstile Widget -->
            <div class="w-full px-4 py-2 bg-primary-800/50 border border-primary-700 rounded-lg flex justify-center items-center">
              <div class="cf-turnstile [&>iframe]:!block" data-sitekey={TURNSTILE_SITE_KEY} data-theme="dark"></div>
            </div>

            <Button type="submit" id="submit-btn" fullWidth>
              <span id="submit-text">Send Message</span>
              <span id="submit-loading" class="hidden">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Sending...
              </span>
              <svg id="submit-arrow" class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </Button>
          </form>
        </AnimatedSection>

        <!-- Contact Info -->
        <AnimatedSection client:visible direction="right" delay={0.2}>
          <h2 class="text-h3 font-heading font-semibold text-primary-100 mb-6">
            Other Ways to Reach Us
          </h2>

          <div class="space-y-6">
            <!-- Email -->
            <a href={`mailto:${SITE.email}`} class="card block group cursor-pointer transition-all duration-150 hover:scale-[1.02] hover:border-accent-500/30">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-lg bg-accent-500/10 flex items-center justify-center flex-shrink-0 group-hover:bg-accent-500/20 transition-colors">
                  <svg class="w-6 h-6 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-primary-100 group-hover:text-accent-400 transition-colors">Email</h3>
                  <span class="text-accent-400 group-hover:text-accent-300">
                    {SITE.email}
                  </span>
                  <p class="text-sm text-primary-500 mt-1">We typically respond within 24 hours.</p>
                </div>
              </div>
            </a>

            <!-- Book a Call -->
            <a href="#" class="card block group cursor-pointer transition-all duration-150 hover:scale-[1.02] hover:border-accent-500/30">
              <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-lg bg-accent-500/10 flex items-center justify-center flex-shrink-0 group-hover:bg-accent-500/20 transition-colors">
                  <svg class="w-6 h-6 text-accent-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-primary-100 group-hover:text-accent-400 transition-colors">Book a Call</h3>
                  <p class="text-primary-400">
                    Schedule a 15-minute intro call to discuss your needs.
                  </p>
                  <span class="inline-flex items-center gap-2 text-accent-400 group-hover:text-accent-300 mt-2 text-sm font-medium">
                    Book a time
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </span>
                </div>
              </div>
            </a>

            <!-- Response Time -->
            <div class="glass rounded-xl p-6">
              <p class="text-sm text-primary-400">
                <span class="text-accent-400 font-semibold">Response Time:</span> We pride ourselves on fast communication. Expect a response within 24 hours on business days.
              </p>
            </div>

            <!-- Friendly Image -->
            <div class="mt-8 rounded-xl overflow-hidden">
              <img
                src={IMAGES.about.mission}
                alt="Collaboration and partnership"
                class="w-full h-48 object-cover"
                loading="lazy"
              />
            </div>
          </div>
        </AnimatedSection>
      </div>
    </div>
  </section>

  <!-- Why Reach Out Section -->
  <section class="section-sm bg-primary-900">
    <div class="container-wide">
      <AnimatedSection client:visible>
        <div class="glass rounded-2xl p-8 lg:p-12">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 text-center">
            <div>
              <div class="contact-icon contact-icon-1 w-16 h-16 rounded-full bg-accent-500/10 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">üí¨</span>
              </div>
              <h3 class="font-heading font-semibold text-primary-100">No Pressure</h3>
              <p class="mt-2 text-sm text-primary-400">We're here to help, not sell. Ask anything.</p>
            </div>
            <div>
              <div class="contact-icon contact-icon-2 w-16 h-16 rounded-full bg-accent-500/10 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">ü§ù</span>
              </div>
              <h3 class="font-heading font-semibold text-primary-100">Real People</h3>
              <p class="mt-2 text-sm text-primary-400">Talk directly with Larry or Jeff.</p>
            </div>
            <div>
              <div class="contact-icon contact-icon-3 w-16 h-16 rounded-full bg-accent-500/10 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">‚ö°</span>
              </div>
              <h3 class="font-heading font-semibold text-primary-100">Quick Response</h3>
              <p class="mt-2 text-sm text-primary-400">24-hour response on business days.</p>
            </div>
          </div>
        </div>
      </AnimatedSection>
    </div>
  </section>
</BaseLayout>

<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script define:vars={{ CONTACT_API_URL }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    const submitArrow = document.getElementById('submit-arrow');
    const successDiv = document.getElementById('form-success');
    const errorDiv = document.getElementById('form-error');
    const errorMessage = document.getElementById('error-message');

    if (!form || !submitBtn) return;

    // Helper to show/hide loading state
    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitText.classList.toggle('hidden', loading);
      submitLoading.classList.toggle('hidden', !loading);
      submitArrow.classList.toggle('hidden', loading);
    }

    // Helper to show success/error messages
    function showMessage(type, message) {
      successDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      if (type === 'success') {
        successDiv.classList.remove('hidden');
        form.reset();
        // Reset Turnstile widget
        if (window.turnstile) {
          window.turnstile.reset();
        }
      } else {
        errorDiv.classList.remove('hidden');
        if (message) {
          errorMessage.textContent = message;
        }
      }

      // Scroll to message
      const messageEl = type === 'success' ? successDiv : errorDiv;
      messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Clear previous messages
      successDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');

      // Get form data
      const formData = new FormData(form);
      const data = {
        firstName: formData.get('firstName')?.toString().trim() || '',
        lastName: formData.get('lastName')?.toString().trim() || '',
        email: formData.get('email')?.toString().trim() || '',
        company: formData.get('company')?.toString().trim() || '',
        phone: formData.get('phone')?.toString().trim() || '',
        interest: formData.get('interest')?.toString() || '',
        message: formData.get('message')?.toString().trim() || '',
        turnstileToken: formData.get('cf-turnstile-response')?.toString() || '',
      };

      // Client-side validation
      if (!data.firstName) {
        showMessage('error', 'Please enter your first name.');
        return;
      }
      if (!data.lastName) {
        showMessage('error', 'Please enter your last name.');
        return;
      }
      if (!data.email || !data.email.includes('@')) {
        showMessage('error', 'Please enter a valid email address.');
        return;
      }
      if (!data.message || data.message.length < 10) {
        showMessage('error', 'Please enter a message (at least 10 characters).');
        return;
      }
      if (!data.turnstileToken) {
        showMessage('error', 'Please complete the CAPTCHA verification.');
        return;
      }

      // Check if API URL is configured
      if (!CONTACT_API_URL) {
        showMessage('error', 'Contact form is not configured. Please email us directly.');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch(CONTACT_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showMessage('success');
        } else {
          showMessage('error', result.error || 'Unable to send message. Please try again.');
        }
      } catch (error) {
        // SECURITY: Don't log error details to console (could expose sensitive info)
        showMessage('error', 'Network error. Please check your connection and try again.');
      } finally {
        setLoading(false);
      }
    });
  });
</script>

<style>
  /* Contact icons pulse */
  .contact-icon {
    animation: contact-glow 9s ease-in-out infinite;
  }

  .contact-icon-1 { animation-delay: 0s; }
  .contact-icon-2 { animation-delay: 3s; }
  .contact-icon-3 { animation-delay: 6s; }

  @keyframes contact-glow {
    0%, 15%, 100% {
      box-shadow: none;
    }
    7% {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.2);
    }
  }

  /* Turnstile dark theme adjustments */
  .cf-turnstile {
    margin: 0 auto;
  }
</style>
